# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/).

## [Unreleased]

### Added

- Initial repository scaffolding (docs + planning).
- Fedbox scaffold for federation smoke tests.
- Zig project skeleton and minimal HTTP server with `/healthz`.
- SQLite DB wrapper and migrations (including initial `users` table).
- Password hashing (Argon2id) and single-user creation/login helpers.
- App wiring and basic Mastodon-compatible instance endpoint (`/api/v1/instance`).
- Minimal HTML signup/login and session cookies.
- OAuth 2.0 app registration and authorization-code flow (`/api/v1/apps`, `/oauth/authorize`, `/oauth/token`).
- Bearer-token auth for `/api/v1/accounts/verify_credentials`.
- Status posting and timelines (SQLite `statuses` table; `POST /api/v1/statuses`, `GET /api/v1/timelines/home`, `GET /api/v1/statuses/:id`).
- Public timeline endpoint (`GET /api/v1/timelines/public`).
- Additional timeline placeholder endpoints (`GET /api/v1/timelines/tag/:tag`, `GET /api/v1/timelines/list/:id`, `GET /api/v1/timelines/link`).
- Mastodon streaming endpoint via WebSockets (`GET /api/v1/streaming`, `stream=user`, `access_token=...`).
- Local and remote posts publish `event=update` on the streaming user stream.
- Local and remote deletes publish `event=delete` on the streaming user stream.
- Inbound follows publish `event=notification` on the streaming user stream.
- Mastodon v2 instance endpoint (`GET /api/v2/instance`) for client compatibility.
- Media upload + serving (`POST /api/v1/media`, `PUT /api/v1/media/:id`, `GET /media/:token`).
- Status posting accepts `media_ids[]` and returns `media_attachments` on status payloads.
- Deleting a status removes any attached media; stale unattached media is pruned opportunistically.
- Initial ActivityPub discovery endpoints: WebFinger, NodeInfo, and actor document (`/.well-known/webfinger`, `/.well-known/nodeinfo`, `/nodeinfo/2.0`, `/users/:name`).
- Host-meta discovery endpoint (`/.well-known/host-meta`) advertising WebFinger LRDD template.
- Per-actor RSA keypairs (stored in SQLite) and `publicKeyPem` in the ActivityPub actor document.
- HTTP Signatures helper for signing outbound ActivityPub requests (`Digest`, `Date`, `Signature`).
- Verify inbound ActivityPub inbox requests using HTTP Signatures + `Digest` (rejects unsigned/invalid deliveries).
- Inbox signature verification supports `hs2019`, `content-type`, `content-length`, and `X-Forwarded-Host` (reverse proxy / fedbox compatibility).
- Remote actor discovery storage + follow tracking tables, plus inbox handling for `Accept` to mark follows as accepted.
- Outbound federation follow (WebFinger → actor → signed Follow to inbox), plus `POST /api/v1/follows` for clients and `FEDDYSPICE_CACERTFILE` for custom TLS CAs (fedbox).
- Inbox handling for ActivityPub `Create` to store remote posts in SQLite (`remote_statuses` table).
- Home timeline + status lookup can return remote posts (negative `id`s in `GET /api/v1/timelines/home` and `GET /api/v1/statuses/:id`).
- Followers table + helpers for tracking inbound follows (remote accounts following this user).
- Inbox handling for ActivityPub `Follow`: store inbound follower + send signed `Accept`; expose `GET /users/:name/followers` and `GET /users/:name/following` collections.
- Inbound ActivityPub `Follow` creates a Mastodon-style `follow` notification (`GET /api/v1/notifications`).
- ActivityPub outbox + object endpoints (`GET /users/:name/outbox`, `GET /users/:name/statuses/:id`).
- Local posts are federated to accepted followers via signed ActivityPub `Create(Note)` deliveries.
- Outbound federation work is offloaded to background jobs to avoid blocking request handling.
- Docker image for feddyspice + fedbox compose integration (`docker/federation/compose.yml`).
- Fedbox E2E tests cover feddyspice federation (follow + post delivery).
- Fedbox E2E test covers inbound signed `direct` messages and ensures they never leak into the public timeline.
- Basic access logging plus optional file logs (`FEDDYSPICE_LOG_FILE`, `FEDDYSPICE_LOG_LEVEL`).
- Prometheus-style metrics endpoint (`GET /metrics`).
- `mise` loads local env from `.env` (gitignored) and provides `.env.example`.
- Additional Mastodon API placeholder endpoints used by Elk/pl-fe (notifications, markers, preferences, search, etc.).
- Notifications API endpoints (`GET /api/v1/notifications`, `POST /api/v1/notifications/clear`, `POST /api/v1/notifications/:id/dismiss`).
- Streaming health endpoint (`GET /api/v1/streaming/health`).
- Account lookup + profile endpoint (`GET /api/v1/accounts/lookup`, `GET /api/v1/accounts/:id`).
- Accounts relationships endpoint (`GET /api/v1/accounts/relationships`).
- Account statuses endpoint (`GET /api/v1/accounts/:id/statuses`).
- Account followers/following endpoints (`GET /api/v1/accounts/:id/followers`, `GET /api/v1/accounts/:id/following`).
- Soft-delete support for local + remote statuses (`deleted_at`).
- Delete local status endpoint (`DELETE /api/v1/statuses/:id`).
- Status context endpoint (`GET /api/v1/statuses/:id/context`).
- Status action endpoints (no-op compat): favourite/reblog/bookmark (`POST /api/v1/statuses/:id/{favourite,unfavourite,reblog,unreblog,bookmark,unbookmark}`).
- Deleted local ActivityPub objects return Tombstones (`GET /users/:name/statuses/:id`).
- ActivityPub `Delete` deliveries to followers when local statuses are deleted.
- ActivityPub inbox handling for `Delete` to mark remote statuses deleted.
- Inbox idempotency via `inbox_dedupe` table to avoid reprocessing duplicate ActivityPub deliveries.
- Timeline pagination (`max_id`, `since_id`, `min_id`) with `Link` headers on home/public timelines.
- `GET /api/v2/search` resolves acct handles via WebFinger (enables finding remote accounts in pl-fe/Elk).
- `POST /api/v1/accounts/:id/follow` and `POST /api/v1/accounts/:id/unfollow` for client follow UX.
- Stable, path-safe numeric IDs for remote accounts (SQLite `rowid`-based offset).
- `zig build test -Dtest-filter="..."` support for faster test iteration.
- Pluggable HTTP transport layer (`RealTransport`, `NullTransport`, `MockTransport`) to enable networkless unit tests.
- Configurable outbound HTTP timeout (`FEDDYSPICE_HTTP_TIMEOUT_MS`).
- Configurable outbound HTTP max response size (`FEDDYSPICE_HTTP_MAX_BODY_BYTES`) to avoid unbounded memory usage on remote fetches.
- Configurable background job execution mode (`FEDDYSPICE_JOBS_MODE`) and an in-memory job queue for deterministic tests.
- SQLite-backed background job queue (`jobs` table) with retries/backoff and a worker thread (used when `FEDDYSPICE_JOBS_MODE=spawn`).
- Background follow delivery logs (`SendFollowJob`) and thread-spawn failure logs for background jobs.
- SQLite-backed media attachments schema + DB helpers (including unguessable public URLs) for `POST /api/v1/media` and status attachments.
- Remote account profile media (avatars/headers) are parsed from ActivityPub actor documents and exposed via the Mastodon API.
- Remote status attachments are parsed from inbound ActivityPub notes and exposed via `media_attachments` in the Mastodon API.
- Implemented Mastodon media v2 upload endpoint (`POST /api/v2/media`) and media metadata fetch (`GET /api/v1/media/:id`) for pl-fe compatibility.
- User profile fields stored in SQLite (`display_name`, `note`, `avatar_media_id`, `header_media_id`).
- Profile updates via `PATCH /api/v1/accounts/update_credentials` (display name, bio, avatar, header).
- ActivityPub actor documents include `name`, `summary`, `icon`, and `image` when profile fields are set.
- Mastodon conversations endpoints for DMs (`GET /api/v1/conversations`, `POST /api/v1/conversations/:id/read`, `DELETE /api/v1/conversations/:id`).
- Additional client-compat endpoints to eliminate 404s (`GET /api/v1/instance/peers`, `GET /api/v1/instance/activity`, `GET /api/v1/instance/extended_description`, `GET /api/v1/directory`, `GET /nodeinfo/2.1`, `GET /robots.txt`).
- Outbound federation of `visibility=direct` statuses to mentioned recipients (ActivityPub Create/Delete with `to=[actor ids]`, no `Public` recipients).
- Outbound federation direct deliveries store resolved recipient actor IDs in SQLite to avoid reparsing mentions or re-resolving handles.

### Changed

- Extracted shared helpers (`htmlEscapeAlloc`, `textToHtmlAlloc`, URL builders, remote account API ID mapping) into `src/util/*` for easier modularization.
- Moved HTTP `Request`/`Response` types into `src/http_types.zig` to allow splitting `src/http.zig` without import cycles.
- Moved NodeInfo/host-meta handlers into `src/http/discovery.zig`.
- Moved instance endpoints into `src/http/instance.zig`.
- Added `src/http/common.zig` for shared HTTP helpers used across handler modules.
- Moved WebFinger handler into `src/http/discovery.zig`.
- Expanded `src/http/common.zig` with shared HTML/redirect/body-parsing helpers to support further handler modularization.
- Moved `/signup` and `/login` handlers into `src/http/pages.zig`.
- Added `src/http/session.zig` for cookie/session helpers shared by OAuth and HTML auth pages.
- Moved OAuth app registration + authorization-code flow handlers into `src/http/oauth_api.zig`.
- Added `src/http/urls.zig` to share URL-building helpers across HTTP modules.
- Added `src/http/mastodon.zig` for shared Mastodon API payload structs + builders (accounts/statuses/media).
- Added `src/http/accounts_api.zig` and moved core account endpoints (`verify_credentials`, `update_credentials`, `lookup`).
- Moved remaining account/search endpoints into `src/http/accounts_api.zig` (`GET /api/v2/search`, `/api/v1/accounts/:id`, relationships, follow/unfollow, followers/following, statuses).
- Added `src/http/statuses_api.zig` and moved status endpoints (`POST /api/v1/statuses`, `GET /api/v1/statuses/:id`, `GET /api/v1/statuses/:id/context`, `DELETE /api/v1/statuses/:id`, and no-op action endpoints).
- Added `src/http/timelines_api.zig` and moved timeline endpoints (`GET /api/v1/timelines/home`, `GET /api/v1/timelines/public`).
- Added `src/http/activitypub_api.zig` and moved ActivityPub endpoints (`/users/:name` actor, inbox, outbox, followers/following, object endpoints).
- DRY: refactored signed ActivityPub inbox POST deliveries into shared helpers in `src/federation.zig`.
- Reduced per-request allocations in `src/server.zig` by building response headers on the stack or request arena instead of `page_allocator`.
- Hardened redirect handling by rejecting CR/LF in `Location` values (`/login?return_to=...`, OAuth/HTML redirects).
- Added `src/http/media_api.zig` and moved media endpoints out of `src/http.zig` (`/media/:token`, `/api/v1/media`, `/api/v2/media`).
- Added `src/http/notifications_api.zig` and moved notifications endpoints out of `src/http.zig` (`/api/v1/notifications`, `/api/v1/notifications/clear`, `/api/v1/notifications/:id/dismiss`).
- Added `src/http/conversations_api.zig` and moved conversation endpoints out of `src/http.zig` (`/api/v1/conversations`, `/api/v1/conversations/:id/read`, `DELETE /api/v1/conversations/:id`).
- Added `src/http/follows_api.zig` and moved `POST /api/v1/follows` out of `src/http.zig`.
- Added `src/http/compat_api.zig` for client-compat placeholder endpoints (custom emojis, markers, preferences, and other empty-list endpoints).
- Added `src/http/metrics_api.zig` and moved `GET /metrics` out of `src/http.zig`.

### Fixed

- Access logs no longer include query strings (prevents leaking `access_token` from streaming URLs), and redacts `/media/:token` paths.
- Logs escape control characters when printing untrusted strings (prevents log forging via newlines in remote responses or OAuth params).
- Remote ActivityPub ingest now ignores non-`http(s)` Note IDs and attachment URLs; remote actor docs with mismatched IDs are rejected (hardens against URL-scheme injection and actor ID spoofing).
- Outbound fetch SSRF checks now also validate the connected peer IP address (mitigates DNS-rebinding bypass of pre-connect DNS checks).
- Outbound HTTP fetches now apply per-host concurrency limits and failure backoff (`FEDDYSPICE_HTTP_MAX_INFLIGHT_PER_HOST`, `FEDDYSPICE_HTTP_FAILURE_BACKOFF_*`) to reduce fetch-storm impact.
- Remote ActivityPub Note `content` is sanitized on ingest before being stored/re-served (prevents XSS via remote HTML).
- Response header values are filtered to prevent CR/LF injection; user-controlled media `content_type` is sanitized to a safe default.
- HTTP responses include baseline security headers (nosniff, no-referrer, deny framing; CSP for HTML pages).
- Inbound ActivityPub inbox signature verification now enforces `Date` max clock skew (`FEDDYSPICE_SIGNATURE_MAX_CLOCK_SKEW_SEC`) to reduce replay risk.
- ActivityPub inbox requests now reject excessively nested JSON payloads (`FEDDYSPICE_JSON_MAX_NESTING_DEPTH`) to reduce DoS risk.
- ActivityPub inbox requests now reject JSON payloads with too many structural tokens (`FEDDYSPICE_JSON_MAX_TOKENS`) to reduce DoS risk.
- Status creation now enforces a max of 4 media attachments; inbound remote Note attachments are capped to 4 (reduces abuse/DoS risk).
- Outbound federation fetches now reject explicit nonstandard ports by default (`FEDDYSPICE_HTTP_ALLOW_NONSTANDARD_PORTS=false`) to reduce SSRF blast radius.
- OAuth token responses include `Cache-Control: no-store` / `Pragma: no-cache`; HTML form POSTs (`/login`, `/signup`, `/oauth/authorize`) enforce same-origin when `Origin`/`Referer` is present.
- Inbox idempotency now falls back to a body-hash dedupe key when an ActivityPub activity `id` is missing (reduces replay/dup processing).
- Added basic SQLite-backed rate limiting for high-risk entrypoints (`/login`, `/signup`, `/oauth/token`, `/api/v1/apps`, and ActivityPub inbox) to reduce brute-force/DoS impact.
- `Dockerfile` Zig download works on both amd64/arm64 Docker builders.
- Mastodon-ish API endpoints accept client JSON + multipart form-data bodies (pl-fe/Elk compatibility) and send permissive CORS headers.
- `/api/v2/instance` now advertises the correct streaming base URL (`ws(s)://domain`, not a nested `/api/v1/streaming` path).
- Streaming WebSocket events now include `stream` (e.g. `["user"]`) for multiplexed clients like pl-fe.
- WebSocket streaming now echoes `Sec-WebSocket-Protocol` when the client requests it (pl-fe passes the access token as a subprotocol).
- Form parsing deallocates owned key/value buffers correctly; multipart parsing can now extract file parts (for media uploads).
- Fedbox Docker network creation is more reliable via a configurable subnet (`FEDBOX_SUBNET`).
- Fedbox smoke tests handle API differences between servers (follow fallback + HTML content entity decoding).
- `/oauth/token` returns OAuth-style JSON errors and logs why auth-code exchange failed (helps debug pl-fe issues).
- OAuth redirect parameters and hidden form fields are more robust via percent-encoding + HTML escaping.
- Account payloads include valid `url`/`avatar_static`/`header`/`header_static` values for pl-fe validation, with placeholder image endpoints.
- `GET /api/v2/instance` includes `configuration.urls.streaming` and `configuration.polls` to avoid Elk client crashes.
- `GET /api/v1/markers` includes required `updated_at`, and status payloads include `sensitive` (pl-fe validation).
- SQLite statements bind text/blob as `SQLITE_TRANSIENT` to avoid pointer lifetime issues.
- Inbound ActivityPub `Create` no longer silently ignores unknown actors (fetches the actor doc on first contact).
- Inbound ActivityPub `Create` infers `direct` vs `public` visibility based on recipients.
- `POST /api/v1/follows` is idempotent when the follow already exists.
- Actor key generation tolerates concurrent requests (avoids transient failures when multiple requests race to create keys).
- Unit tests no longer spin up local HTTP servers for federation flows; they use `MockTransport` + queued jobs instead.
- `App.initFromConfig` no longer returns an `App` with a dangling transport pointer (prevents HTTPS outbound segfaults).
- HTTPS outbound requests with a body flush the underlying connection correctly (fixes federation POST failures like `Follow` deliveries).
- Outbound ActivityPub deliveries prefer the remote actor's `sharedInbox` when available.
- Inbox `Accept` handling tolerates trailing-slash variants of the follow activity ID.
- `job_worker` uses `std.Thread.sleep` (fixes Linux/Docker builds with Zig 0.15.2).
- ActivityPub visibility is enforced more strictly: outbox/object endpoints exclude `private`/`direct`, unlisted uses `cc=Public`, and outbound Create/Delete deliveries no longer leak non-public posts to `Public`.
- Outbound Create/Delete deliveries now also fan out to stored recipients (e.g. mentions) even when there are no followers.
- `POST /api/v1/accounts/:id/unfollow` now sends ActivityPub `Undo(Follow)` to the remote inbox (previously local-only).
- Inbox handling now supports ActivityPub `Undo(Follow)` to remove inbound followers.
- Inbound ActivityPub `Create` distinguishes `unlisted` (Public in `cc`) from `public` (Public in `to`).
- `mise run fed:test` is more reliable by bringing up the fedbox stack explicitly before running the test runner.
- Outbound HTTP requests enforce basic SSRF protections (DNS-based) by blocking private/loopback/link-local/multicast ranges by default; fedbox enables private ranges via `FEDDYSPICE_ALLOW_PRIVATE_NETWORKS=true`.
- `POST /api/v1/statuses` now allows an empty `status` when at least one `media_ids[]` attachment is present.
- Orphan media pruning no longer deletes profile avatar/header media.
- HTTP `HEAD` requests are treated like `GET` (but with an empty body), and trailing-slash paths are normalized for basic client/crawler compatibility.
