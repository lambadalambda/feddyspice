services:
  gateway:
    image: caddy:2.8
    restart: unless-stopped
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_fed_data:/data/caddy
    networks:
      federation:
        aliases:
          - feddyspice.fedbox.dev
          - pleroma.fedbox.dev
          - mastodon.fedbox.dev

  gateway_certs:
    image: caddy:2.8
    restart: "no"
    depends_on:
      gateway:
        condition: service_started
    volumes:
      - caddy_fed_data:/data/caddy
    command:
      - sh
      - -lc
      - |
        set -eu

        while [ ! -f /data/caddy/pki/authorities/local/root.crt ]; do
          sleep 1
        done

        chmod 755 /data/caddy/pki /data/caddy/pki/authorities /data/caddy/pki/authorities/local
        chmod 644 /data/caddy/pki/authorities/local/root.crt
    networks:
      - federation

  feddyspice_web:
    profiles: ["fedtest", "feddyspice"]
    build:
      context: ../..
    image: feddyspice-fedbox
    restart: unless-stopped
    depends_on:
      gateway_certs:
        condition: service_completed_successfully
    environment:
      FEDDYSPICE_DOMAIN: feddyspice.fedbox.dev
      FEDDYSPICE_SCHEME: https
      FEDDYSPICE_LISTEN: 0.0.0.0:8080
      FEDDYSPICE_DB_PATH: /data/feddyspice.sqlite3
      FEDDYSPICE_CACERTFILE: /caddy/pki/authorities/local/root.crt
      # Needed for federation-in-a-box; feddyspice must fetch actors/inboxes on the Docker subnet.
      FEDDYSPICE_ALLOW_PRIVATE_NETWORKS: "true"
      # Needed for dm_sender actor discovery (http://dm_sender:8000/...), and other fedbox-only helpers.
      FEDDYSPICE_HTTP_ALLOW_NONSTANDARD_PORTS: "true"
    volumes:
      - feddyspice_fed_data:/data
      - caddy_fed_data:/caddy:ro
    networks:
      - federation
    expose:
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8080/healthz >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  feddyspice_seed:
    profiles: ["fedtest", "feddyspice"]
    image: alpine:3.20
    restart: "no"
    depends_on:
      feddyspice_web:
        condition: service_healthy
    volumes:
      - ./feddyspice/seed.sh:/seed/feddyspice_seed.sh:ro
    command:
      - sh
      - /seed/feddyspice_seed.sh
    networks:
      - federation

  dm_sender:
    profiles: ["fedtest"]
    build:
      context: ./dm_sender
    restart: unless-stopped
    networks:
      - federation
    expose:
      - "8000"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://127.0.0.1:8000/healthz\", timeout=2).read()'"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 2s

  pleroma_db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: pleroma
      POSTGRES_PASSWORD: pleroma
      POSTGRES_DB: pleroma
    volumes:
      - pleroma_fed_db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pleroma"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - federation

  pleroma_web:
    build:
      context: ${PLEROMA_CONTEXT:-../../../pleroma}
    image: pleroma-fedbox
    restart: unless-stopped
    depends_on:
      pleroma_db:
        condition: service_healthy
    environment:
      DOMAIN: pleroma.fedbox.dev
      INSTANCE_NAME: Pleroma (fedbox)
      ADMIN_EMAIL: admin@pleroma.fedbox.dev
      NOTIFY_EMAIL: notify@pleroma.fedbox.dev
      DB_HOST: pleroma_db
      DB_PORT: 5432
      DB_NAME: pleroma
      DB_USER: pleroma
      DB_PASS: pleroma
      FEDBOX_CACERTFILE: /caddy/pki/authorities/local/root.crt
    volumes:
      - pleroma_fed_data:/var/lib/pleroma
      - ./pleroma/config.exs:/var/lib/pleroma/config.exs:ro
      - caddy_fed_data:/caddy:ro
    expose:
      - "4000"
    healthcheck:
      test:
        ["CMD-SHELL", "wget -qO- http://127.0.0.1:4000/api/v1/instance >/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - federation

  pleroma_seed:
    image: pleroma-fedbox
    restart: "no"
    depends_on:
      pleroma_web:
        condition: service_healthy
    entrypoint: []
    environment:
      DOMAIN: pleroma.fedbox.dev
      DB_HOST: pleroma_db
      DB_PORT: 5432
      DB_NAME: pleroma
      DB_USER: pleroma
      DB_PASS: pleroma
      FEDBOX_CACERTFILE: /caddy/pki/authorities/local/root.crt
    volumes:
      - pleroma_fed_data:/var/lib/pleroma
      - ./pleroma/config.exs:/var/lib/pleroma/config.exs:ro
      - ./pleroma/seed.sh:/seed/pleroma_seed.sh:ro
    command:
      - sh
      - /seed/pleroma_seed.sh
    networks:
      - federation

  mastodon_db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: mastodon
      POSTGRES_PASSWORD: mastodon
      POSTGRES_DB: mastodon
    volumes:
      - mastodon_fed_db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mastodon"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - federation

  mastodon_redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - mastodon_fed_redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - federation

  mastodon_init:
    image: ${MASTODON_IMAGE:-ghcr.io/mastodon/mastodon:v4.5.3}
    restart: "no"
    depends_on:
      gateway_certs:
        condition: service_completed_successfully
      mastodon_db:
        condition: service_healthy
      mastodon_redis:
        condition: service_healthy
    environment: &mastodon_env
      RAILS_ENV: production
      NODE_ENV: production
      PORT: 3000
      LOCAL_DOMAIN: mastodon.fedbox.dev
      WEB_DOMAIN: mastodon.fedbox.dev
      ANNOTATERB_SKIP_ON_DB_TASKS: "true"
      REDIS_HOST: mastodon_redis
      REDIS_PORT: 6379
      DB_HOST: mastodon_db
      DB_PORT: 5432
      DB_NAME: mastodon
      DB_USER: mastodon
      DB_PASS: mastodon
      # Allow common Docker/private ranges for federation-in-a-box.
      ALLOWED_PRIVATE_ADDRESSES: "10.0.0.0/8 172.16.0.0/12 192.168.0.0/16"
      SSL_CERT_FILE: /caddy/pki/authorities/local/root.crt
      OTP_SECRET: "fedbox_otp_secret_mastodon"
      SECRET_KEY_BASE: "fca7fa5fe8ca9b7bbcaa442535b973e772e6392f46aab7fb3ec227ef5eb8d8c6605b921f7af4c2cc41f19a20633334e11c6012d6de958d0b14c4c2aa24a294ab"
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: "ZVdBBUYdAX9il2dZ3mwVRv1h7bDnRlH9oybCdHautQUNIhSBoV7wdpKm+ByScMaeEChmrmxIhIMBujlnikHUqA=="
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: "82yPOOdC5iAbaCU7ck0hsWP1kJqMH8g7v/vtzS+AlWBFsVvcuzGYBg888Oa+vBkhXY8Xr1jE03WbSwVwHDR3Aw=="
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: "6UZS4kC1TsljaOCidkEGQHqnIIcN0zqayJu2ANKYAHsLtKnjZOvcEvhDehRaf0LfQNHim/9asXmILvVukOuw0w=="
    command:
      - sh
      - -lc
      - |
        set -euo pipefail

        bundle exec rails db:prepare

        # Create an initial user for federation smoke tests.
        bin/tootctl accounts create carol --email carol@mastodon.fedbox.dev --confirmed --approve --role Owner || true

        # Ensure a stable password for the OAuth authorization code flow.
        bundle exec rails runner 'u = User.find_by(email: "carol@mastodon.fedbox.dev"); raise "carol missing" unless u; u.mark_email_as_confirmed! unless u.confirmed?; u.approve! unless u.approved?; u.change_password!("password");'
    volumes:
      - mastodon_fed_system:/mastodon/public/system
      - ./mastodon/initializers/00_letter_opener_web_stub.rb:/opt/mastodon/config/initializers/00_letter_opener_web_stub.rb:ro
      - ./mastodon/initializers/01_fedbox_settings.rb:/opt/mastodon/config/initializers/01_fedbox_settings.rb:ro
      - caddy_fed_data:/caddy:ro
    networks:
      - federation

  mastodon_web:
    image: ${MASTODON_IMAGE:-ghcr.io/mastodon/mastodon:v4.5.3}
    restart: unless-stopped
    depends_on:
      mastodon_init:
        condition: service_completed_successfully
    environment: *mastodon_env
    command: bundle exec puma -C config/puma.rb
    expose:
      - "3000"
    volumes:
      - mastodon_fed_system:/mastodon/public/system
      - ./mastodon/initializers/00_letter_opener_web_stub.rb:/opt/mastodon/config/initializers/00_letter_opener_web_stub.rb:ro
      - ./mastodon/initializers/01_fedbox_settings.rb:/opt/mastodon/config/initializers/01_fedbox_settings.rb:ro
      - caddy_fed_data:/caddy:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -s --noproxy localhost localhost:3000/health | grep -q 'OK' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - federation

  mastodon_sidekiq:
    image: ${MASTODON_IMAGE:-ghcr.io/mastodon/mastodon:v4.5.3}
    restart: unless-stopped
    depends_on:
      mastodon_init:
        condition: service_completed_successfully
    environment: *mastodon_env
    command: bundle exec sidekiq
    volumes:
      - mastodon_fed_system:/mastodon/public/system
      - ./mastodon/initializers/00_letter_opener_web_stub.rb:/opt/mastodon/config/initializers/00_letter_opener_web_stub.rb:ro
      - ./mastodon/initializers/01_fedbox_settings.rb:/opt/mastodon/config/initializers/01_fedbox_settings.rb:ro
      - caddy_fed_data:/caddy:ro
    networks:
      - federation

  fedtest:
    profiles: ["fedtest"]
    build:
      context: ./test_runner
    image: feddyspice-fedbox-test-runner
    depends_on:
      gateway_certs:
        condition: service_completed_successfully
      feddyspice_seed:
        condition: service_completed_successfully
      pleroma_seed:
        condition: service_completed_successfully
      pleroma_web:
        condition: service_healthy
      mastodon_web:
        condition: service_healthy
      mastodon_sidekiq:
        condition: service_started
    environment:
      FEDTEST_SCHEME: https
      FEDTEST_PLEROMA_HANDLE: "@bob@pleroma.fedbox.dev"
      FEDTEST_MASTODON_HANDLE: "@carol@mastodon.fedbox.dev"
      FEDTEST_FEDDYSPICE_HANDLE: "@alice@feddyspice.fedbox.dev"
      FEDTEST_PASSWORD: "password"
      FEDTEST_CACERTFILE: /caddy/pki/authorities/local/root.crt
    networks:
      - federation
    volumes:
      - caddy_fed_data:/caddy:ro

networks:
  federation:
    ipam:
      driver: default
      config:
        - subnet: ${FEDBOX_SUBNET:-10.77.0.0/16}

volumes:
  caddy_fed_data:
  feddyspice_fed_data:
  pleroma_fed_db:
  pleroma_fed_data:
  mastodon_fed_db:
  mastodon_fed_redis:
  mastodon_fed_system:
